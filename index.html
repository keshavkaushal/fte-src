<!DOCTYPE html>
<html>
<head>
    <script src="phaser.min.js"></script>
    <script src="midi-parser.js"></script>
    <script src="midiToEvents.js"></script>
</head>
<body style="margin: 1px; overflow: hidden;">
    <input style="display:none" type="file" id="filereader">
    <script>

        // SCRIPT TO LISTEN FOR NEW MIDIs
        var MIIDI;

        window.onload = function(){
            var source = document.getElementById('filereader');
            MidiParser.parse( source, function(obj){
                MIIDI = obj;
                MIDI_LOADED = true;
                console.log(MIIDI);
            });
        };

        var config = {
            type: Phaser.AUTO,
            scale: {
                mode: Phaser.Scale.FIT,
                parent: 'phaser-example',
                autoCenter: Phaser.Scale.CENTER_BOTH,
                width: 1600,
                height: 900
            },
            scene: {
                create: create,
                update: update,
                preload: preload,
            }
        };

        var MIDI_LOADED = false;
        var TICKRATE = 1;
        var PAUSED = false;

        // BUTTONS

        var pause;
        var play;

        var graphics;
        var statics;
        var tick = 0
        var midi = [[25, 10, 80], [35, 90, 50], [20, 140, 80]]
        var game = new Phaser.Game(config);

        function preload()
        {
            this.load.image('play', '/play.png');
            this.load.image('pause', '/pause.png');
            this.load.image('restart', '/restart.png');
            this.load.image('upload', '/upload.png');
            this.load.image('ff', '/ff.png');
            this.load.image('rw', '/rw.png');
            this.load.image('switch', '/switch.png');
        }

        function create ()
        {
            graphics = this.add.graphics();

            play = this.add.image(60, 360, 'play');
            play.setInteractive().on('pointerdown', () => playpause());
            play.visible = false;

            pause = this.add.image(60, 360, 'pause');
            pause.setInteractive().on('pointerdown', () => playpause());
            
            var restart = this.add.image(60, 660, 'restart');
            restart.setInteractive().on('pointerdown', () => restartfn());
            
            var upload = this.add.image(60, 160, 'upload');
            upload.setInteractive().on('pointerdown', () => document.getElementById('filereader').click());

            var swit = this.add.image(60, 260, 'switch');
            restart.setInteractive().on('pointerdown', () => restartfn());





            var ff = this.add.image(60, 460, 'ff');
            ff.setInteractive().on('pointerdown', () => speedup());

            var rw = this.add.image(60, 560, 'rw');
            rw.setInteractive().on('pointerdown', () => slowdown());



            // const midiin = this.add.text(50, 50, 'MIDI', { fill: '#0f0' });
            // // midiin.setText(['MIDI']);
            // midiin.setFontSize(60);
            // midiin.setInteractive().on('pointerdown', () => document.getElementById('filereader').click());

            // const playpause = this.add.text(50, 150, 'Play/Pause', { fill: '#0f0' });
            // playpause.setFontSize(60);
            // playpause.setInteractive().on('pointerdown', () => document.getElementById('filereader').click());
        }

        function restartfn ()
        {
            tick = 0;
        }

        function speedup ()
        {
            TICKRATE = TICKRATE * 2;
        }

        function slowdown ()
        {
            TICKRATE = TICKRATE / 2;
        }

        function playpause ()
        {
            PAUSED = !PAUSED;
            pause.visible = !pause.visible;
            play.visible = !play.visible;
        }

        function update ()
        {
            if (MIDI_LOADED){
                if(!PAUSED){
                    tick = tick + TICKRATE;
                }
                
            };


            graphics.clear();
            draw_white_keys();
            draw_notes();
            draw_black_keys();

        }

        function draw_white_keys ()
        {
            graphics.fillStyle(0xffffff, 1);

            for (let i = 0; i < 52; i++) {
                graphics.fillRect((i*30)+22, 760, 25, 140);
            } 
        }

        function draw_black_keys ()
        {
            graphics.fillStyle(0x222222, 1);

            black_keys_order = ['y',
            'n', 'y', 'y', 'n', 'y', 'y', 'y',
            'n', 'y', 'y', 'n', 'y', 'y', 'y',
            'n', 'y', 'y', 'n', 'y', 'y', 'y',
            'n', 'y', 'y', 'n', 'y', 'y', 'y',
            'n', 'y', 'y', 'n', 'y', 'y', 'y',
            'n', 'y', 'y', 'n', 'y', 'y', 'y',
            'n', 'y', 'y', 'n', 'y', 'y', 'y',]

            for (let i = 0; i < 52; i++) {
                if (black_keys_order[i] == 'y'){
                    graphics.fillRect((i*30)+41, 760, 17, 95);
                }
            }  
        }

        function draw_notes ()
        {
            midi.forEach(function(item, index, array) {
                note = item[0]
                start = item[1]
                duration = item[2]

                x = (note*30)+22
                y = tick - start - duration

                // THE FALLING NOTE, STOPS WHEN THE TOP OF THE BAR HITS THE PIANO
                if (y < 760){
                    graphics.fillStyle(0xa5fed2, 1);
                    graphics.fillRect(x, y, 25, duration);
                }

                if (tick - start > 760){
                    if (y < 760){
                        graphics.fillRect(x, 760, 25, 140);
                    }
                }
            })  

        }
    </script>

</body>
</html>